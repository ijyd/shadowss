image: seanchanndockerhub/docker

variables:
  DOCKER_IMAGE: ""
  DOCKER_IMAGE_TAG: ""

stages:
  - build_image
  - publish_image

build_image:
  stage: build_image
  artifacts:
    paths:
      - context/
  script:
    - mkdir context
    - cd build
    - result=$(bash -x ./make-build-image.sh)
    - echo $result
    - 'DOCKER_IMAGE=${result%%:*}'
    - 'DOCKER_IMAGE_TAG=${result##*:}'
    - echo "output image:${DOCKER_IMAGE} tag:${DOCKER_IMAGE_TAG}"
    - echo "export DOCKER_IMAGE=$(echo ${DOCKER_IMAGE})" >> ../context/build_result
    - echo "export DOCKER_IMAGE_TAG=$(echo ${DOCKER_IMAGE_TAG})" >> ../context/build_result
  only:
    - 3.0.1@cloud/cloud-keeper

publish_image:
  stage: publish_image
  script:
    - source context/build_result
    - tag=$DOCKER_IMAGE:$DOCKER_IMAGE_TAG
    - latest=$DOCKER_IMAGE:latest
    - echo "push latest image(${latest}) and actual image(${tag})"
    - docker login -u admin -p H43598b0c0dfe20ab3ef551475de626c dockerhub.bj-jyd.cn
    - docker tag $tag $latest
    - docker push $tag
    - docker push $latest
